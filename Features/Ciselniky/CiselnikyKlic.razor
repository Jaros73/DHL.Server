@page "/ciselniky/klic"
@using DHL.Server.Features.Ciselniky.Models
@using DHL.Server.Features.Ciselniky.Components
@using DHL.Server.Features.Ciselniky.Interfaces
@using MudBlazor
@inject IKlicService CiselnikyService
@inject IDialogService DialogService
@inject AuthenticationStateProvider AuthenticationStateProvider


<MudPaper Class="p-4">
    <MudText Typo="Typo.h5" Class="mb-2">Seznam Klíčů</MudText>
    <MudButton Variant="Variant.Filled"
               Color="Color.Primary"
               OnClick="CreateKey"
               StartIcon="@Icons.Material.Filled.Add">
        Přidat
    </MudButton>
    <MudTable Items="_keys" Hover="true" Dense="true" Bordered="true">
        <HeaderContent>
            <MudTh>Název</MudTh>
            <MudTh>Stav</MudTh>
            <MudTh>Založeno</MudTh>
            <MudTh>Akce</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Název">@context.Name</MudTd>
            <MudTd DataLabel="Stav">
                <MudChip T="string"
                         Color="@(context.IsActive ? Color.Success : Color.Default)"
                         Variant="Variant.Filled"
                         Size="Size.Small">
                    @(context.IsActive ? "Aktivní" : "Neaktivní")
                </MudChip>
            </MudTd>
            <MudTd DataLabel="Založeno">@context.CreatedAt.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</MudTd>
            <MudTd DataLabel="Akce">
                <MudIconButton Icon="@Icons.Material.Filled.Edit"
                               Color="Color.Primary"
                               OnClick="() => OpenEditDialog(context)" />
                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                               Color="Color.Error"
                               OnClick="() => DeleteKey(context.Id)" />
            </MudTd>
        </RowTemplate>
    </MudTable>


</MudPaper>

@code {
    private List<KlicDto> _keys = new();

    protected override async Task OnInitializedAsync()
    {
        _keys = await CiselnikyService.GetAllAsync();
    }

    private async Task OpenEditDialog(KlicDto original)
    {
        var dto = new KlicDto
            {
                Id = original.Id,
                Name = original.Name,
                IsActive = original.IsActive,
                CreatedAt = original.CreatedAt,
                CreatedBy = original.CreatedBy,
                Updated = original.Updated
            };

        var parameters = new DialogParameters { ["Model"] = dto };
        var options = new DialogOptions
            {
                CloseButton = true,
                MaxWidth = MaxWidth.Small,
                FullWidth = true
            };

        var dialogRef = await DialogService.ShowAsync<KlicDialog>(
            dto.Id == 0 ? "Nový klíč" : "Úprava klíče", parameters, options);

        var result = await dialogRef.Result;

        if (result != null && !result.Canceled && result.Data is KlicDto updated)
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userName = authState.User.Identity?.Name ?? "systemus";

            updated.CreatedBy = string.IsNullOrWhiteSpace(updated.CreatedBy) ? userName : updated.CreatedBy;

            KlicDto ulozeny;

            if (updated.Id == 0)
            {
                ulozeny = await CiselnikyService.CreateAsync(updated);
                _keys.Add(ulozeny);
            }
            else
            {
                ulozeny = await CiselnikyService.UpdateAsync(updated.Id, updated) ?? updated;
                var index = _keys.FindIndex(k => k.Id == ulozeny.Id);
                if (index >= 0)
                    _keys[index] = ulozeny;
            }

           // _keys = _keys.OrderBy(k => k.Name).ToList();
            _keys = await CiselnikyService.GetAllAsync();
            StateHasChanged();
        }
    }


    private async Task CreateKey()
    {
        await OpenEditDialog(new KlicDto());
    }

    private async Task DeleteKey(int id)
    {
        await CiselnikyService.DeleteAsync(id);
        _keys = await CiselnikyService.GetAllAsync();
        StateHasChanged();
    }
}

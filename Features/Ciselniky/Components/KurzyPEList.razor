@using DHL.Server.Features.Ciselniky.Models
@using DHL.Server.Features.Ciselniky.Interfaces
@using DHL.Server.Features.Ciselniky.Services
@using Microsoft.AspNetCore.Components.Forms
@inject IKurzyPEService KurzyPEService
@inject KurzyPEImportService ImportService
@inject IWebHostEnvironment Environment
@inject IDialogService DialogService

<MudPaper Class="p-4">

    <MudText Typo="Typo.h5" Class="mb-2">Plánované kurzy PE</MudText>

    <div class="mb-2">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="CreateKurz" StartIcon="@Icons.Material.Filled.Add">
            Nový kurz +
        </MudButton>
        <MudButton Variant="Variant.Outlined" Color="Color.Error" OnClick="DeleteAllKurzy" StartIcon="@Icons.Material.Filled.DeleteForever" Class="ml-2">
            Smazat vše
        </MudButton>
        <label class="mud-button-root mud-button mud-button-outlined mud-button-default ml-2" style="cursor: pointer;">
            <MudIcon Icon="@Icons.Material.Filled.UploadFile" Class="mud-icon-root mud-icon-start" />
            <span class="mud-button-label">Nahrát CSV</span>
            <InputFile OnChange="HandleFileUpload" class="d-none" />
        </label>
    </div>


    <MudTable @ref="table"
              T="KurzyPEDto"
              ServerData="LoadServerData"
              Hover="true"
              Dense="true"
              Striped="true"
              FixedHeader="true"
              Height="400px"
              RowsPerPage="10"
              Elevation="0">

            <HeaderContent>
                <MudTh>AP</MudTh>
                <MudTh>Název kurzu</MudTh>
                <MudTh>TC</MudTh>
                <MudTh>Zastávka</MudTh>
                <MudTh>PSČ</MudTh>
                <MudTh>Příjezd</MudTh>
                <MudTh>Odjezd</MudTh>
                <MudTh>Akce</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.AP</MudTd>
                <MudTd>@context.NazevKurzu</MudTd>
                <MudTd>@context.TC</MudTd>
                <MudTd>@context.Zastavka</MudTd>
                <MudTd>@context.PSCzastavky</MudTd>
                <MudTd>@context.Prijezd.ToString(@"hh\:mm")</MudTd>
                <MudTd>@context.Odjezd.ToString(@"hh\:mm")</MudTd>
                <MudTd>
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" OnClick="() => EditKurz(context)" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" OnClick="() => DeleteKurz(context.Id)" />
                </MudTd>
            </RowTemplate>
        </MudTable>

</MudPaper>


@code {
    private MudTable<KurzyPEDto>? table;

    private string _searchString = string.Empty;

    private async Task ReloadData()
    {
        if (table is not null)
            await table.ReloadServerData();
    }

    private async Task CreateKurz() => await OpenEditDialog(new KurzyPEDto());

    private async Task EditKurz(KurzyPEDto kurz) => await OpenEditDialog(kurz);

    private async Task OpenEditDialog(KurzyPEDto original)
    {
        var parameters = new DialogParameters { ["Model"] = original };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

        var dialogRef = await DialogService.ShowAsync<KurzyPEEditDialog>(
            original.Id == 0 ? "Nový kurz PE" : "Úprava kurzu PE", parameters, options);

        var result = await dialogRef.Result;

        if (result != null && !result.Canceled && result.Data is KurzyPEDto updated)
        {
            if (updated.Id == 0)
            {
                await KurzyPEService.CreateAsync(updated);
            }
            else
            {
                await KurzyPEService.UpdateAsync(updated.Id, updated);
            }

            if (table is not null)
                await table.ReloadServerData();
        }
    }

    private async Task DeleteKurz(int id)
    {
        var confirmed = await DialogService.ShowMessageBox("Potvrzení", "Opravdu chcete smazat kurz?", "Ano", "Ne");
        if (confirmed == true)
        {
            await KurzyPEService.DeleteAsync(id);
            if (table is not null)
                await table.ReloadServerData();
        }
    }

    private async Task DeleteAllKurzy()
    {
        var confirmed = await DialogService.ShowMessageBox("Potvrzení", "Opravdu chcete smazat všechny kurzy?", "Ano", "Ne");
        if (confirmed == true)
        {
            var allKurzy = await KurzyPEService.GetAllAsync();
            foreach (var kurz in allKurzy)
            {
                await KurzyPEService.DeleteAsync(kurz.Id);
            }

            if (table is not null)
                await table.ReloadServerData();
        }
    }

    private async Task HandleFileUpload(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null || !file.Name.EndsWith(".csv", StringComparison.OrdinalIgnoreCase))
        {
            await DialogService.ShowMessageBox("Chyba", "Prosím nahrajte soubor ve formátu CSV.");
            return;
        }

        var tempFilePath = Path.Combine(Environment.ContentRootPath, "Temp", $"kurzy_{Guid.NewGuid()}.csv");
        Directory.CreateDirectory(Path.GetDirectoryName(tempFilePath)!);

        await using var stream = File.Create(tempFilePath);
        await file.OpenReadStream(10 * 1024 * 1024).CopyToAsync(stream);

        var count = await ImportService.ImportFromCsvAsync(tempFilePath);

        File.Delete(tempFilePath);
        await DialogService.ShowMessageBox("Import dokončen", $"Načeteno záznamů: {count}");

        if (table is not null)
            await table.ReloadServerData();
    }

    private async Task<TableData<KurzyPEDto>> LoadServerData(TableState state, CancellationToken cancellationToken)
    {
        var result = await KurzyPEService.GetPageAsync(
            skip: state.Page * state.PageSize,
            take: state.PageSize,
            search: _searchString);

        return new TableData<KurzyPEDto>
            {
                TotalItems = result.TotalCount,
                Items = result.Items
            };
    }



}

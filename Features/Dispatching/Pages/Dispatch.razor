@page "/dispecerska-sluzba"
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims
@using ClosedXML.Excel;
@attribute [Authorize]
@using DHL.Server.Features.Dispatching.Interfaces
@using DHL.Server.Features.Dispatching.Models
@using DHL.Server.Models.Entities
@using AutoMapper;
@inject IDispatchService DispatchService
@inject IDialogService DialogService
@inject IJSRuntime JS
@inject IMapper Mapper

<MudContainer MaxWidth="MaxWidth.False" Class="mt-4 px-4">
    <MudStack Spacing="2">
        <MudText Typo="Typo.h5" Class="font-weight-bold">Dispečerská služba</MudText>

        <MudGrid>
            <MudItem xs="12">
                <MudStack Row Wrap="Wrap.Wrap" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">

                    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="OpenCreateDialog">
                        + Vytvořit
                    </MudButton>

                    <MudStack Row AlignItems="AlignItems.Center" Spacing="1">
                        <MudButton Variant="Variant.Text" OnClick="ExportToExcel">Export</MudButton>
                        <MudButton Variant="Variant.Text" OnClick="Reload">Aktualizovat</MudButton>
                        <MudTextField @bind-Value="searchText"
                                      Placeholder="Vyhledat..."
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Search"
                                      Margin="Margin.Dense"
                                      Class="ml-4" />
                    </MudStack>
                </MudStack>
            </MudItem>
        </MudGrid>

        <MudTable Items="GetFiltered()"
                  Hover="true"
                  Dense="true"
                  Bordered="true"
                  Elevation="0"
                  Class="mt-2">
            <HeaderContent>
                <MudTh>Vytvořeno</MudTh>
                <MudTh>TC</MudTh>
                <MudTh>Datum</MudTh>
                <MudTh>Typ</MudTh>
                <MudTh>Klíč</MudTh>
                <MudTh>Popis</MudTh>
                <MudTh>Aktualizováno</MudTh>
                <MudTh>Akce</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>@context.CreatedAt.ToLocalTime().ToString("d. M. yyyy H:mm")</MudTd>
                <MudTd>@context.LocationName</MudTd>
                <MudTd>@context.UserTime.ToLocalTime().ToString("d. M. yyyy H:mm")</MudTd>
                <MudTd>@context.TypeEnumName</MudTd>
                <MudTd>@context.KeyEnumName</MudTd>
                <MudTd>@context.Description</MudTd>
                <MudTd>@context.UpdatedAt?.ToLocalTime().ToString("d. M. yyyy H:mm")</MudTd>
                <MudTd>
                    <MudIconButton Icon="@Icons.Material.Filled.ContentCopy" Color="Color.Default" Size="Size.Small" OnClick="@(() => DuplicateAsNew(context))" />
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary" Size="Size.Small" OnClick="@(() => OpenEditDialog(context))" />
                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error" Size="Size.Small" OnClick="@(() => DeleteDispatch(context))" />
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Color="Color.Error" Typo="Typo.subtitle2" Class="px-4 py-2">
                    Zatím žádná data k dispozici.
                </MudText>
            </NoRecordsContent>
        </MudTable>
    </MudStack>
</MudContainer>

@if (_isUploading)
{
    <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" />
}

@code {
    @implements IDisposable
    private bool _isUploading = false;
    private CancellationTokenSource _cts = new();

    private List<DispatchModelEntity> FilteredDispatches = new();
    private string searchText = string.Empty;

    protected override async Task OnInitializedAsync() => await LoadDispatches();

    private async Task LoadDispatches()
    {
        try
        {
            var all = await DispatchService.GetDispatchesAsync(_cts.Token);
            FilteredDispatches = all.OrderByDescending(x => x.CreatedAt).ToList();
        }
        catch
        {
            FilteredDispatches = new();
        }
    }

    public void Dispose() => _cts.Cancel();

    private async Task Reload() => await LoadDispatches();

    private IEnumerable<DispatchModelEntity> GetFiltered()
    {
        if (string.IsNullOrWhiteSpace(searchText))
            return FilteredDispatches;

        var lower = searchText.ToLower();
        return FilteredDispatches.Where(d =>
            (d.LocationName?.ToLower().Contains(lower) ?? false) ||
            (d.TypeEnumName?.ToLower().Contains(lower) ?? false) ||
            (d.KeyEnumName?.ToLower().Contains(lower) ?? false) ||
            (d.Description?.ToLower().Contains(lower) ?? false)
        );
    }

    private async Task DeleteDispatch(DispatchModelEntity entity)
    {
        bool confirmed = await DialogService.ShowMessageBox(
            "Potvrzení",
            "Opravdu chcete smazat tento záznam?",
            yesText: "Ano", cancelText: "Ne") == true;

        if (confirmed)
        {
            await DispatchService.DeleteDispatchAsync(entity.Id);
            await LoadDispatches();
            StateHasChanged();
        }
    }

    private async void OpenCreateDialog()
    {
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialogRef = await DialogService.ShowAsync<DispatchDialog>("Vytvořit záznam", options);
        var result = await dialogRef.Result;

        if (result is not null && !result.Canceled)
        {
            await LoadDispatches();
            StateHasChanged();
        }
    }

    private async Task OpenEditDialog(DispatchModelEntity entity)
    {
        var dto = Mapper.Map<DispatchModelDto>(entity);
        var parameters = new DialogParameters { ["Dispatch"] = dto };

        var options = new DialogOptions
            {
                CloseButton = true,
                MaxWidth = MaxWidth.Medium,
                FullWidth = true,
                NoHeader = false,
                Position = DialogPosition.Center
            };

        var dialogRef = await DialogService.ShowAsync<DispatchDialog>("Upravit záznam", parameters, options);
        var result = await dialogRef.Result;

        if (result is not null && !result.Canceled)
        {
            await LoadDispatches();
            StateHasChanged();
        }
    }

    private async Task DuplicateAsNew(DispatchModelEntity entity)
    {
        var dto = Mapper.Map<DispatchModelDto>(entity);
        dto.Id = 0;
        dto.CreatedAt = DateTime.UtcNow;
        dto.UpdatedAt = null;

        var parameters = new DialogParameters { ["Dispatch"] = dto };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Medium, FullWidth = true };

        var dialogRef = await DialogService.ShowAsync<DispatchDialog>("Duplikát záznamu", parameters, options);
        var result = await dialogRef.Result;

        if (result is not null && !result.Canceled)
        {
            await LoadDispatches();
            StateHasChanged();
        }
    }

    private async Task ExportToExcel()
    {
        _isUploading = true;
        try
        {
            using var workbook = new XLWorkbook();
            var worksheet = workbook.Worksheets.Add("Dispečerská služba");

            worksheet.Cell(1, 1).Value = "Vytvořeno";
            worksheet.Cell(1, 2).Value = "TC";
            worksheet.Cell(1, 3).Value = "Datum";
            worksheet.Cell(1, 4).Value = "Typ";
            worksheet.Cell(1, 5).Value = "Klíč";
            worksheet.Cell(1, 6).Value = "Popis";
            worksheet.Cell(1, 7).Value = "Aktualizováno";

            var filtered = GetFiltered().ToList();
            for (int i = 0; i < filtered.Count; i++)
            {
                var d = filtered[i];
                worksheet.Cell(i + 2, 1).Value = d.CreatedAt.ToLocalTime().ToString("d. M. yyyy H:mm:ss");
                worksheet.Cell(i + 2, 2).Value = d.LocationName;
                worksheet.Cell(i + 2, 3).Value = d.UserTime.ToLocalTime().ToString("d. M. yyyy H:mm:ss");
                worksheet.Cell(i + 2, 4).Value = d.TypeEnumName;
                worksheet.Cell(i + 2, 5).Value = d.KeyEnumName;
                worksheet.Cell(i + 2, 6).Value = d.Description;
                worksheet.Cell(i + 2, 7).Value = d.UpdatedAt?.ToLocalTime().ToString("d. M. yyyy H:mm:ss") ?? "";

            }

            worksheet.Columns().AdjustToContents();

            using var stream = new MemoryStream();
            workbook.SaveAs(stream);
            var content = stream.ToArray();
            var fileName = $"ExportDHL_{DateTime.Now:ddMMyy_HHmmss}.xlsx";

            await JS.InvokeVoidAsync("downloadFileFromBytes", fileName, Convert.ToBase64String(content));
        }
        finally
        {
            _isUploading = false;
        }
    }
}

@using DHL.Server.Features.Dispatching.Interfaces
@using DHL.Server.Features.Dispatching.Models
@using DHL.Server.Features.Ciselniky.Interfaces
@using DHL.Server.Features.Ciselniky.Models
@using Microsoft.AspNetCore.Components.Authorization
@inject IKlicService KlicService
@inject ILocationService LocationService
@inject IDialogService DialogService
@inject IDispatchService DispatchService
@inject AuthenticationStateProvider AuthProvider

<MudDialog>
    <DialogContent>
        <MudStack Spacing="2">
            <MudText Typo="Typo.h6">Nový dispečerský záznam</MudText>

            <MudSelect T="int" Label="DSPU" @bind-Value="_model.LocationId" Required="true">
                @foreach (var loc in _meta.Locations)
                {
                    <MudSelectItem Value="@loc.Id">@loc.Name</MudSelectItem>
                }
            </MudSelect>

            <MudSelect T="int" Label="Typ události" @bind-Value="_model.TypeEnumId" Required="true">
                @foreach (var type in _meta.Types)
                {
                    <MudSelectItem Value="@type.Id">@type.Name</MudSelectItem>
                }
            </MudSelect>

            <MudSelect T="int" Label="Klíč události" @bind-Value="_model.KeyEnumId" Required="true">
                @foreach (var key in _meta.Keys)
                {
                    <MudSelectItem Value="@key.Id">@key.Name</MudSelectItem>
                }
            </MudSelect>

            <MudDatePicker Label="Datum a čas události"
            Value="_model.UserTime"
            ValueChanged="v => _model.UserTime = v"
            Required="true"
            EnableTime="true"
            TimeEdit="true"
            DateFormat="dd.MM.yyyy HH:mm"
            PickerVariant="PickerVariant.Inline" />


            <MudTextField Label="Popis události"
            @bind-Value="_model.Description"
            Lines="3"
            FullWidth="true" />
        </MudStack>
    </DialogContent>

    <DialogActions>
        <MudButton OnClick="Cancel" Color="Color.Secondary">Zrušit</MudButton>
        <MudButton OnClick="Save" Color="Color.Primary">Uložit</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; } = default!;
    private DispatchModelDto _model = new();
    private DispatchMeta _meta = new();

    protected override async Task OnInitializedAsync()
    {
        _meta = await DispatchService.GetMetadataAsync();
        _model.CreatedAt = DateTime.UtcNow;
        _model.UserTime = DateTime.UtcNow;

        var auth = await AuthProvider.GetAuthenticationStateAsync();
        _model.CreatedBy = auth.User.Identity?.Name ?? "system";
        _model.CreatedByFullName = _model.CreatedBy;
    }

    private async Task Save()
    {
        _model.LocationName = _meta.Locations.FirstOrDefault(l => l.Id == _model.Id)?.Name ?? string.Empty;
        _model.TypeEnumName = _meta.Types.FirstOrDefault(t => t.Id == _model.TypeEnumId)?.Name ?? string.Empty;
        _model.KeyEnumName = _meta.Keys.FirstOrDefault(k => k.Id == _model.KeyEnumId)?.Name ?? string.Empty;

        await DispatchService.CreateDispatchDtoAsync(_model);
        MudDialog.Close(DialogResult.Ok(_model));
    }

    private void Cancel() => MudDialog.Cancel();
}
